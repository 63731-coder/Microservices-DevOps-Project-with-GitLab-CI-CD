stages:
  - build
  - test
  - infrastructure
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  ACR_NAME: scenarioregistry63731
  ACR_LOGIN_SERVER: scenarioregistry63731.azurecr.io
  IMAGE_PYTHON: "$ACR_LOGIN_SERVER/63731-service-python:latest"
  IMAGE_JAVA: "$ACR_LOGIN_SERVER/63731-service-java:latest"

#######################
# üì¶ BUILD SERVICES
#######################

build-java:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd service-java
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - service-java/target/

build-python:
  stage: build
  image: gitlab-local/python:3.11-slim
  script:
    - cd service-python
    - pip install -r requirements.txt
  artifacts:
    paths:
      - service-python/
    expire_in: 1h

#######################
# ‚úÖ TEST SERVICES
#######################

test-java:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd service-java
    - mvn test

test-python:
  stage: test
  image: gitlab-local/python:3.11-slim
  script:
    - cd service-python
    - pip install -r requirements.txt
    - python test_app.py

#######################
# ‚òÅÔ∏è TERRAFORM INFRA
#######################

infrastructure:
  stage: infrastructure
  image:
    name: hashicorp/terraform:1.3.9
    entrypoint: [""]
  script:
    - cd terraform
    - terraform init
    - terraform apply -auto-approve

#######################
# üöÄ DEPLOY TO AZURE
#######################

deploy:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - apk add --no-cache bash curl jq python3 py3-pip
    - pip install azure-cli
    - az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID"
  script:
    # üîß Build & Push
    - docker build -t $IMAGE_PYTHON ./service-python
    - docker build -t $IMAGE_JAVA ./service-java
    - az acr login --name $ACR_NAME
    - docker push $IMAGE_PYTHON
    - docker push $IMAGE_JAVA

    # üîÑ Restart Web Apps
    - az webapp restart --name mon-app-python-63731 --resource-group rg-microservices-app
    - az webapp restart --name mon-app-java-63731 --resource-group rg-microservices-app
